var Scripts;!function(r){var t;!function(r){var t=function(){function r(){}return r.toInstance=function(r,t){var e=JSON.parse(t);if("function"==typeof r.fromJSON)r.fromJSON(e);else for(var a in e)r[a]=e[a];return r},r}();r.SerializationHelper=t}(t=r.Components||(r.Components={}))}(Scripts||(Scripts={}));var Scripts;!function(r){var t;!function(r){var t=function(){function r(){}return r}();r.TrelloBoard=t;var e=function(){function r(){}return r}();r.TrelloAction=e;var a=function(){function r(){}return r}();r.TrelloCard=a;var o=function(){function r(){}return r}();r.TrelloMember=o}(t=r.Components||(r.Components={}))}(Scripts||(Scripts={}));var Scripts;!function(r){var t;!function(r){var t=function(){function r(){}return r}();r.TrelloData=t;var e=function(){function r(){}return r}();r.TrelloList=e;var a=function(){function r(){}return r}();r.aggregatedCard=a;var o=function(){function r(){}return r}();r.trelloTaskList=o;var n=function(){function r(){}return r}();r.trelloTask=n;var i=function(){function r(){}return r}();r.TrelloJsonBoard=i;var s=function(){function r(){this.boards=ko.observable()}return r}();r.koBoardView=s;var l=function(){function r(){this.boardName=ko.observable(),this.aggregatedCards=ko.observable(),this.tasks=ko.observable()}return r}();r.koCardView=l}(t=r.Components||(r.Components={}))}(Scripts||(Scripts={}));var Scripts;!function(r){var t;!function(r){var t=function(){function t(){this.trelloKey="48237542d67ee82a6bf1417f16582b86",this.initialize()}return t.prototype.initialize=function(){var t=this;this.cardView=new r.koCardView,this.boardView=new r.koBoardView,ko.applyBindings(this.cardView,document.getElementById("cardsTemplate")),ko.applyBindings(this.boardView,document.getElementById("boardsTemplate"));var e=this;$("#processTrelloFile").click(function(){$("#boardsTemplate").hide(),$("#trelloJsonFile").change(function(){e.uploadFile()}),document.getElementById("trelloJsonFile").click()}),$("#processTrelloApiButton").click(function(){t.authenticateWithTrello()}),$(window).scroll(function(){{var r=$(window).scrollTop(),t=$(window).height();$(document).height()}r>t?$("#toTop").fadeIn():$("#toTop").fadeOut()}),$("#toTop").click(function(){$("html, body").animate({scrollTop:0},"slow")})},t.prototype.uploadFile=function(){var t=this,e=document.getElementById("trelloJsonFile");if(e.files.length>0){var a=e.files[0],o=new FileReader;o.onload=function(e){var a=e.target.result,o=r.SerializationHelper.toInstance(new r.TrelloBoard,a);t.parseJson(o,t)},o.readAsText(a)}},t.prototype.getDataFromApi=function(r,t){$.ajax(r,{success:function(r){t(r)},error:function(){console.log("error")}})},t.prototype.authenticateWithTrello=function(){var r=this,t=function(){console.log("Successful authentication"),r.getDataFromApi("https://api.trello.com/1/members/me/boards?key="+r.trelloKey+"&token="+Trello.token(),function(t){r.boardView.boards(t),$("#boardsTemplate").show(),$("html, body").animate({scrollTop:$("#boardsTemplate").offset().top},"slow"),$(".boardButton").click(function(t){$(".boardButton").removeClass("active"),$(t.target).addClass("active");{var e=$(t.target).attr("data-id");r.getDataFromApi("https://api.trello.com/1/boards/"+e+"?actions=createCard&lists=all&members=all&cards=all&key="+r.trelloKey+"&token="+Trello.token(),function(t){r.parseJson(t,r)})}})})},e=function(){console.log("Failed authentication")};Trello.authorize({type:"popup",name:"TrelloStatistics",scope:{read:!0,write:!1},expiration:"never",success:t,error:e})},t.prototype.getCreatedActionByCard=function(r){var t=this.trelloBoard.actions;for(var e in t)if(t[e].data&&t[e].data.card&&t[e].data.card.id===r&&"createCard"===t[e].type)return t[e];return null},t.prototype.showErrorMessage=function(r){$("#errorMsg").show(),$("#errorMsg").html(r)},t.prototype.getCardsByMonthYear=function(r,t,e){var a=new Array;for(var o in r){var n=r[o],i=new Date(n.dateLastActivity),s=this.getCreatedActionByCard(n.id);null!==s&&(i=new Date(s.date)),i.getFullYear()===t&&i.getMonth()===e&&a.push(n)}return a},t.prototype.getCardsByUser=function(t,e){var a=new Array;for(var o in t){var n=t[o];if(n.idMembers.indexOf(e)>-1){var i=new r.trelloTask;i.title=n.name,i.url=n.shortUrl,a.push(i)}else if(0===n.idMembers.length){var s=this.getCreatedActionByCard(n.id);if(null!==s&&s.idMemberCreator===e){var i=new r.trelloTask;i.title=n.name,i.url=n.shortUrl,a.push(i)}}}return a},t.prototype.aggregateBySwimlane=function(t,e){var a=new Array;for(var o in e){var n=e[o],i=0;for(var s in t){var l=t[s];l.idList===n.id&&(i+=1)}var c=new r.aggregatedCard;c.count=i,c.name=n.name,a.push(c)}return a},t.prototype.aggregateCards=function(t,e){var a=new Array;for(var o in t){var n=0,i=t[o];for(var s in e){var l=e[s];l.idMembers.indexOf(i.id)>-1&&n++}if(n>0){var c=new r.aggregatedCard;c.name=i.fullName,c.count=n,a.push(c)}}return a},t.prototype.convertAreaChart=function(r,t){var e=[];e.push(["month"]);for(var a in r){var o=r[a];e[0].push(o.fullName)}for(var n=0;12>n;n++){var i=this.getCardsByMonthYear(t,(new Date).getFullYear(),n),s=this.aggregateCards(r,i);e.push([""+(n+1)]);for(var a in r){var o=r[a],l=!1;for(var c in s){var d=s[c];d.name===o.fullName&&(e[n+1].push(s[c].count),l=!0)}l||e[n+1].push(0)}}return e},t.prototype.convertPieChart=function(r){var t=[];t.push(["name","amount"]);for(var e in r)t.push([r[e].name,r[e].count]);return t},t.prototype.drawPieGraphUsers=function(r,t){var e=this.aggregateCards(r,t),a=google.visualization.arrayToDataTable(this.convertPieChart(e)),o={title:"User activity",is3D:!0,width:700,height:700},n=new google.visualization.PieChart(document.getElementById("piechartUser"));n.draw(a,o)},t.prototype.drawPieGraphSwimlanes=function(r,t){var e=this.aggregateBySwimlane(r,t),a=google.visualization.arrayToDataTable(this.convertPieChart(e)),o={title:"Swim lane",is3D:!0,width:700,height:700},n=new google.visualization.PieChart(document.getElementById("piechartSwimlane"));n.draw(a,o)},t.prototype.drawAreaGraph=function(r,t){var e=google.visualization.arrayToDataTable(this.convertAreaChart(r,t)),a={title:"User activity",width:700,height:400},o=new google.visualization.AreaChart(document.getElementById("areachart"));o.draw(e,a)},t.prototype.drawTasks=function(t,e,a){var o=this.aggregateCards(t,e);this.cardView.boardName(a),this.cardView.aggregatedCards(o);var n=new Array;for(var i in t){var s=t[i],l=this.getCardsByUser(e,s.id);if(l.length>0){var c=new r.trelloTaskList;c.icon=s.avatarHash?"https://trello-avatars.s3.amazonaws.com/"+s.avatarHash+"/30.png":void 0,c.userName=s.fullName,c.userTasks=this.getCardsByUser(e,s.id),n.push(c)}}this.cardView.tasks(n)},t.prototype.parseJson=function(r,t){var e=this;this.trelloBoard=r;var a=(this.trelloBoard,[]);a.push('<option value="">All</option>');for(var o=0;12>o;o++)a.push('<option value="'+o+'">'+(o+1)+"</option>");$("#periodDropdown").html(a.join("")),$("#periodDropdown").change(function(){var r=e.trelloBoard.cards,t=$("#periodDropdown").val();""!==t&&(r=e.getCardsByMonthYear(e.trelloBoard.cards,(new Date).getFullYear(),parseInt(t))),e.drawAreaGraph(e.trelloBoard.members,r),e.drawPieGraphUsers(e.trelloBoard.members,r),e.drawPieGraphSwimlanes(r,e.trelloBoard.lists),e.drawTasks(e.trelloBoard.members,r,e.trelloBoard.name)}),this.drawAreaGraph(this.trelloBoard.members,this.trelloBoard.cards),this.drawPieGraphUsers(this.trelloBoard.members,this.trelloBoard.cards),this.drawPieGraphSwimlanes(this.trelloBoard.cards,this.trelloBoard.lists),this.drawTasks(this.trelloBoard.members,this.trelloBoard.cards,this.trelloBoard.name),$("#cardsTemplate").show(),$("html, body").animate({scrollTop:$("#cardsTemplate").offset().top},"slow")},t}();r.TrelloComponentPage=t}(t=r.Components||(r.Components={}))}(Scripts||(Scripts={})),$(document).ready(function(){google||alert("no internet connection!"),google.load("visualization","1",{packages:["corechart"],callback:function(){}});new Scripts.Components.TrelloComponentPage});